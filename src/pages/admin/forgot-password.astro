---
import AuthLayout from '@/layouts/AuthLayout.astro';

export const prerender = false;
---

<AuthLayout title="Quên mật khẩu - CMS Admin">
  <form id="forgot-password-form" class="space-y-6">
    <div class="text-center">
      <h2 class="text-3xl font-bold bg-gradient-to-r from-amber-200 via-yellow-400 to-amber-200 bg-clip-text text-transparent">
        Quên mật khẩu
      </h2>
      <p class="mt-2 text-sm text-gray-400">
        Nhập email để nhận hướng dẫn đặt lại mật khẩu
      </p>
    </div>

    <div id="success-message" class="hidden relative p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 backdrop-blur-sm">
      <p class="text-sm text-emerald-200">
        Nếu email tồn tại, hướng dẫn đặt lại mật khẩu sẽ được gửi cho bạn.
      </p>
    </div>

    <div id="error-message" class="hidden relative p-4 rounded-xl bg-red-500/10 border border-red-500/20 backdrop-blur-sm">
      <p id="error-text" class="text-sm text-red-200"></p>
    </div>

    <div>
      <label for="email" class="block text-sm font-medium text-amber-100 mb-2">
        Email <span class="text-amber-400">*</span>
      </label>
      <input
        type="email"
        id="email"
        class="block w-full px-4 py-3 bg-white/5 border border-amber-400/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400/20 focus:border-amber-400 transition-all duration-200"
        placeholder="your@email.com"
        required
      />
    </div>

    <button
      type="submit"
      class="w-full px-6 py-3 rounded-xl text-base font-semibold text-gray-900 bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-400 hover:from-amber-500 hover:via-yellow-600 hover:to-amber-500 transition-all duration-200"
    >
      Gửi yêu cầu đặt lại mật khẩu
    </button>

    <div class="text-center text-sm text-gray-400">
      Đã nhớ mật khẩu?
      <a href="/admin/login" class="text-amber-400 hover:text-amber-300 transition-colors font-medium">Đăng nhập</a>
    </div>
  </form>

  <script>
    import { authApi } from '@/lib/api';

    const form = document.getElementById('forgot-password-form') as HTMLFormElement | null;
    const emailInput = document.getElementById('email');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();

      const email = (emailInput instanceof HTMLInputElement ? emailInput.value : '').trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailRegex.test(email)) {
        if (errorText) errorText.textContent = 'Email không hợp lệ.';
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
        return;
      }

      try {
        await authApi.forgotPassword(email);
        errorMessage?.classList.add('hidden');
        successMessage?.classList.remove('hidden');
        form.reset();
      } catch (error: any) {
        const message =
          error?.response?.data?.message || 'Gửi yêu cầu thất bại. Vui lòng thử lại.';
        if (errorText) errorText.textContent = message;
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
      }
    });
  </script>
</AuthLayout>
