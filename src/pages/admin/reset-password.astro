---
import AuthLayout from '@/layouts/AuthLayout.astro';

export const prerender = false;
const token = Astro.url.searchParams.get('token');
---

<AuthLayout title="Đặt lại mật khẩu - CMS Admin">
  <form id="reset-password-form" class="space-y-6">
    <div class="text-center">
      <h2 class="text-3xl font-bold bg-gradient-to-r from-amber-200 via-yellow-400 to-amber-200 bg-clip-text text-transparent">
        Đặt lại mật khẩu
      </h2>
      <p class="mt-2 text-sm text-gray-400">
        Tạo mật khẩu mới cho tài khoản của bạn
      </p>
    </div>

    {
      !token && (
        <div class="relative p-4 rounded-xl bg-red-500/10 border border-red-500/20 backdrop-blur-sm">
          <p class="text-sm text-red-200">
            Thiếu token đặt lại mật khẩu. Vui lòng kiểm tra lại liên kết trong email.
          </p>
        </div>
      )
    }

    <div id="success-message" class="hidden relative p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 backdrop-blur-sm">
      <p class="text-sm text-emerald-200">
        Mật khẩu đã được đặt lại. Bạn có thể đăng nhập lại ngay bây giờ.
      </p>
    </div>

    <div id="error-message" class="hidden relative p-4 rounded-xl bg-red-500/10 border border-red-500/20 backdrop-blur-sm">
      <p id="error-text" class="text-sm text-red-200"></p>
    </div>

    <div>
      <label for="password" class="block text-sm font-medium text-amber-100 mb-2">
        Mật khẩu mới <span class="text-amber-400">*</span>
      </label>
      <input
        type="password"
        id="password"
        class="block w-full px-4 py-3 bg-white/5 border border-amber-400/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400/20 focus:border-amber-400 transition-all duration-200"
        placeholder="Tối thiểu 6 ký tự"
        minlength="6"
        required
      />
    </div>

    <div>
      <label for="confirm-password" class="block text-sm font-medium text-amber-100 mb-2">
        Xác nhận mật khẩu <span class="text-amber-400">*</span>
      </label>
      <input
        type="password"
        id="confirm-password"
        class="block w-full px-4 py-3 bg-white/5 border border-amber-400/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-400/20 focus:border-amber-400 transition-all duration-200"
        placeholder="Nhập lại mật khẩu mới"
        minlength="6"
        required
      />
    </div>

    <button
      type="submit"
      class="w-full px-6 py-3 rounded-xl text-base font-semibold text-gray-900 bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-400 hover:from-amber-500 hover:via-yellow-600 hover:to-amber-500 transition-all duration-200"
      disabled={!token}
    >
      Cập nhật mật khẩu
    </button>

    <div class="text-center text-sm text-gray-400">
      <a href="/admin/login" class="text-amber-400 hover:text-amber-300 transition-colors font-medium">Quay lại đăng nhập</a>
    </div>
  </form>

  <script is:inline define:vars={{ hasToken: Boolean(token) }}>
    import { authApi } from '@/lib/api';

    const form = document.getElementById('reset-password-form');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!hasToken) return;

      const password = passwordInput instanceof HTMLInputElement ? passwordInput.value : '';
      const confirmPassword = confirmPasswordInput instanceof HTMLInputElement ? confirmPasswordInput.value : '';

      if (password.length < 6) {
        if (errorText) errorText.textContent = 'Mật khẩu phải có ít nhất 6 ký tự.';
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
        return;
      }

      if (password !== confirmPassword) {
        if (errorText) errorText.textContent = 'Xác nhận mật khẩu không khớp.';
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');

      if (!tokenFromUrl) {
        if (errorText) errorText.textContent = 'Thiếu token đặt lại mật khẩu.';
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
        return;
      }

      try {
        await authApi.resetPassword(tokenFromUrl, password);
        errorMessage?.classList.add('hidden');
        successMessage?.classList.remove('hidden');
        form.reset();
        setTimeout(() => {
          window.location.href = '/admin/login';
        }, 1200);
      } catch (error) {
        const message =
          error?.response?.data?.message || 'Đặt lại mật khẩu thất bại. Vui lòng thử lại.';
        if (errorText) errorText.textContent = message;
        errorMessage?.classList.remove('hidden');
        successMessage?.classList.add('hidden');
      }
    });
  </script>
</AuthLayout>
