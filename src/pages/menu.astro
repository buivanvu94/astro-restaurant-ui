---
import SiteLayout from '@/layouts/SiteLayout.astro';
import type { Product, ProductPrice } from '@/lib/api/products';
import seafoodHero from '@/assets/images/seafood-hero.jpg';
import seafoodRoom from '@/assets/images/seafood-room.jpg';
import seafoodAbout from '@/assets/images/seafood-about.jpg';

export const prerender = false;

interface MenuProductItem {
  id: number;
  name: string;
  desc: string;
  priceText: string;
  imageUrl: string;
  categoryName: string;
  categorySlug: string;
}

interface MenuGroup {
  key: string;
  name: string;
  items: MenuProductItem[];
}

const apiBaseUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:5000/api/v1';
const uploadsBaseUrl = apiBaseUrl.replace(/\/api\/v\d+\/?$/, '');
const fallbackImages = [seafoodHero.src, seafoodRoom.src, seafoodAbout.src];

const formatCurrencyVnd = (value: number): string => `${new Intl.NumberFormat('vi-VN').format(value)} VND`;

const toAbsoluteImageUrl = (path: string | null | undefined): string | null => {
  if (!path) return null;
  if (path.startsWith('http://') || path.startsWith('https://')) return path;
  return `${uploadsBaseUrl}${path.startsWith('/') ? '' : '/'}${path}`;
};

const slugify = (value: string): string => {
  return value
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '')
    .trim();
};

const pickDefaultPrice = (prices: ProductPrice[] | undefined): number | null => {
  if (!prices || prices.length === 0) return null;
  const activePrices = prices.filter((price) => price.status === 'active');
  const defaultPrice = activePrices.find((price) => price.is_default) || activePrices[0];
  if (!defaultPrice) return null;
  return Number(defaultPrice.sale_price ?? defaultPrice.price);
};

const normalizeDesc = (description: string | null | undefined): string => {
  if (!description) return 'Tinh hoa hải sản cao cấp được chế biến theo phong cách fine dining.';
  return description.length > 120 ? `${description.slice(0, 120).trim()}...` : description;
};

const fetchAllPublicProducts = async (): Promise<MenuProductItem[]> => {
  try {
    const allProducts: Product[] = [];
    let page = 1;
    const limit = 60;
    const maxPages = 12;

    while (page <= maxPages) {
      const response = await fetch(`${apiBaseUrl}/products/public?page=${page}&limit=${limit}`, {
        headers: { accept: 'application/json' }
      });

      if (!response.ok) break;

      const payload = await response.json();
      const products: Product[] = Array.isArray(payload?.data) ? payload.data : [];
      if (products.length === 0) break;

      allProducts.push(...products);

      const totalPages = Number(payload?.pagination?.totalPages || payload?.pagination?.total_pages || 1);
      if (page >= totalPages) break;
      page += 1;
    }

    return allProducts.map((product, index) => {
      const categoryName = product.category?.name?.trim() || 'Món đặc biệt';
      const priceValue = pickDefaultPrice(product.prices);
      const imageUrl = toAbsoluteImageUrl(product.featuredImage?.thumbnail_path)
        || toAbsoluteImageUrl(product.featuredImage?.path)
        || fallbackImages[index % fallbackImages.length];

      return {
        id: product.id,
        name: product.name,
        desc: normalizeDesc(product.short_description || product.description),
        priceText: priceValue !== null ? formatCurrencyVnd(priceValue) : 'Liên hệ',
        imageUrl,
        categoryName,
        categorySlug: product.category?.slug || slugify(categoryName) || 'menu'
      };
    });
  } catch {
    return [];
  }
};

const menuItems = await fetchAllPublicProducts();

const groupedMenuMap = menuItems.reduce((map, item) => {
  const key = item.categorySlug;
  if (!map.has(key)) {
    map.set(key, { key, name: item.categoryName, items: [] } as MenuGroup);
  }
  map.get(key)!.items.push(item);
  return map;
}, new Map<string, MenuGroup>());

const groupedMenu = Array.from(groupedMenuMap.values());
---

<SiteLayout title="Thực đơn - Aurelian Seafood" description="Toàn bộ thực đơn hải sản cao cấp theo từng danh mục">
  <section class="relative overflow-hidden">
    <div class="absolute -top-24 -left-24 w-72 h-72 bg-amber-500/20 rounded-full blur-3xl"></div>
    <div class="absolute top-8 right-0 w-72 h-72 bg-teal-400/20 rounded-full blur-3xl"></div>
    <div class="max-w-6xl mx-auto px-6 pt-20 pb-14">
      <p class="menu-kicker fade-up">Aurelian Menu</p>
      <h1 class="menu-page-hero-title fade-up delay-1">Thực đơn hải sản cao cấp</h1>
      <p class="menu-page-lead fade-up delay-2">
        Khám phá toàn bộ món ăn theo từng danh mục, trình bày tinh tế, nguyên liệu tuyển chọn mỗi ngày và mức giá minh bạch.
      </p>
    </div>
  </section>

  <section class="section-shell pt-0" data-menu-page>
    <div class="max-w-6xl mx-auto px-6" data-menu-root>
      {groupedMenu.length > 0 ? (
        <>
          <div class="menu-category-nav" id="menu-category-nav">
            <div class="menu-filter-row" role="tablist" aria-label="Lọc theo danh mục">
              <button class="menu-category-chip is-active" type="button" data-menu-chip data-filter-key="all" aria-pressed="true">
                <span>Tất cả</span>
                <span class="menu-category-count">{menuItems.length}</span>
              </button>
              {groupedMenu.map((group) => (
                <button class="menu-category-chip" type="button" data-menu-chip data-filter-key={group.key} aria-pressed="false">
                  <span>{group.name}</span>
                  <span class="menu-category-count">{group.items.length}</span>
                </button>
              ))}
            </div>
          </div>

          <div class="menu-category-stack">
            {groupedMenu.map((group, groupIndex) => (
              <section
                id={`menu-cat-${group.key}`}
                class="menu-category-section fade-up"
                data-menu-section
                data-category-key={group.key}
                style={`animation-delay: ${Math.min(groupIndex * 0.06, 0.45)}s`}
              >
                <div class="flex flex-wrap items-end justify-between gap-3 mb-6">
                  <div>
                    <p class="menu-kicker">Danh mục</p>
                    <h2 class="menu-category-title">{group.name}</h2>
                  </div>
                  <span class="badge">{group.items.length} món</span>
                </div>

                <div class="menu-catalog-grid">
                  {group.items.map((item) => (
                    <article class="card-glass menu-catalog-card">
                      <div class="menu-catalog-media-wrap">
                        <img
                          src={item.imageUrl}
                          alt={item.name}
                          class="menu-catalog-media"
                          loading="lazy"
                          decoding="async"
                          width="720"
                          height="420"
                        />
                      </div>
                      <div class="p-5 md:p-6">
                        <div class="flex items-center justify-between gap-3 mb-3">
                          <p class="menu-item-name">{item.name}</p>
                          <span class="menu-item-price">{item.priceText}</span>
                        </div>
                        <p class="text-slate-300">{item.desc}</p>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            ))}
          </div>
        </>
      ) : (
        <div class="card-glass p-9 text-center text-slate-200/90">
          Hiện chưa có sản phẩm xuất bản để hiển thị thực đơn.
        </div>
      )}
    </div>
  </section>

  <section class="section-shell">
    <div class="max-w-6xl mx-auto px-6">
      <div class="card-glass p-10 flex flex-col lg:flex-row items-center justify-between gap-6">
        <div>
          <h2 class="text-3xl">Bạn muốn tư vấn set menu riêng?</h2>
          <p class="text-slate-300">Đội ngũ Aurelian hỗ trợ nhanh theo số khách, ngân sách và loại sự kiện.</p>
        </div>
        <a class="btn-primary" href="/lien-he">Liên hệ đặt bàn</a>
      </div>
    </div>
  </section>
</SiteLayout>

<script is:inline>
  (() => {
    const root = document.querySelector('[data-menu-root]');
    if (!root) return;

    const chips = Array.from(root.querySelectorAll('[data-menu-chip]'));
    const sections = Array.from(root.querySelectorAll('[data-menu-section]'));
    const nav = document.getElementById('menu-category-nav');
    if (!chips.length || !sections.length) return;

    let activeFilter = 'all';

    const setActiveChip = (key) => {
      chips.forEach((chip) => {
        const isActive = chip.getAttribute('data-filter-key') === key;
        chip.classList.toggle('is-active', isActive);
        chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    };

    const syncQuery = (key) => {
      const url = new URL(window.location.href);
      if (key === 'all') {
        url.searchParams.delete('category');
      } else {
        url.searchParams.set('category', key);
      }
      window.history.replaceState({}, '', `${url.pathname}${url.search}${url.hash}`);
    };

    const applyFilter = (key, shouldScroll = true) => {
      activeFilter = key;
      const showAll = key === 'all';

      sections.forEach((section) => {
        const sectionKey = section.getAttribute('data-category-key');
        section.hidden = !showAll && sectionKey !== key;
      });

      setActiveChip(key);
      syncQuery(key);

      if (!shouldScroll) return;
      if (showAll) {
        nav?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return;
      }

      const target = sections.find((section) => section.getAttribute('data-category-key') === key);
      target?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const key = chip.getAttribute('data-filter-key') || 'all';
        applyFilter(key, true);
      });
    });

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          if (activeFilter !== 'all') return;
          const visible = entries
            .filter((entry) => entry.isIntersecting)
            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];

          if (!visible) return;
          const key = visible.target.getAttribute('data-category-key');
          if (!key) return;
          setActiveChip(key);
        },
        {
          rootMargin: '-20% 0px -55% 0px',
          threshold: [0.25, 0.4, 0.6]
        }
      );

      sections.forEach((section) => observer.observe(section));
    }

    const fromQuery = new URLSearchParams(window.location.search).get('category');
    if (fromQuery && sections.some((section) => section.getAttribute('data-category-key') === fromQuery)) {
      applyFilter(fromQuery, false);
      return;
    }

    const fromHash = window.location.hash.replace('#menu-cat-', '').trim();
    if (fromHash && sections.some((section) => section.getAttribute('data-category-key') === fromHash)) {
      setActiveChip(fromHash);
      return;
    }

    setActiveChip('all');
    syncQuery('all');
  })();
</script>
