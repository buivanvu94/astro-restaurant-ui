---
import type { Post } from '@/lib/api/posts';
import { fetchJsonWithTimeout, getOrSetCache } from '@/lib/server/perf';
import seafoodHero from '@/assets/images/seafood-hero.jpg';

export const prerender = false;

interface AmpPostDetail {
  slug: string;
  title: string;
  excerpt: string;
  contentText: string;
  categoryName: string;
  publishedAt: string;
  imageUrl: string;
}

const { slug } = Astro.params;
const apiBaseUrl = import.meta.env.PUBLIC_API_URL || 'https://vuapiastronhahang.nguyenluan.vn/api/v1';
const uploadsBaseUrl = apiBaseUrl.replace(/\/api\/v\d+\/?$/, '');
const fallbackImage = seafoodHero.src;

Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=180, stale-while-revalidate=300');

const toAbsoluteImageUrl = (path: string | null | undefined): string | null => {
  if (!path) return null;
  if (path.startsWith('http://') || path.startsWith('https://')) return path;
  return `${uploadsBaseUrl}${path.startsWith('/') ? '' : '/'}${path}`;
};

const formatDateVi = (input: string | null | undefined): string => {
  if (!input) return 'Mới cập nhật';
  const parsed = new Date(input);
  if (Number.isNaN(parsed.getTime())) return 'Mới cập nhật';
  return parsed.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
};

const plainTextFromHtml = (input: string | null | undefined): string => {
  return (input || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
};

const normalizeExcerpt = (excerpt: string | null | undefined, content: string | null | undefined): string => {
  const source = excerpt?.trim() || plainTextFromHtml(content);
  if (!source) return 'Khám phá góc nhìn ẩm thực và trải nghiệm fine dining tại Aurelian Seafood.';
  return source.length > 190 ? `${source.slice(0, 190).trim()}...` : source;
};

const buildAmpPost = (post: Post): AmpPostDetail => {
  return {
    slug: post.slug,
    title: post.title,
    excerpt: normalizeExcerpt(post.excerpt, post.content),
    contentText: plainTextFromHtml(post.content),
    categoryName: post.category?.name || 'Ẩm thực',
    publishedAt: formatDateVi(post.published_at || post.created_at),
    imageUrl:
      toAbsoluteImageUrl(post.featuredImage?.thumbnail_path)
      || toAbsoluteImageUrl(post.featuredImage?.path)
      || fallbackImage
  };
};

const fetchPublicPostBySlug = async (postSlug: string): Promise<AmpPostDetail | null> => {
  try {
    const payload = await fetchJsonWithTimeout<{ data?: Post }>(
      `${apiBaseUrl}/posts/public/slug/${encodeURIComponent(postSlug)}`,
      { headers: { accept: 'application/json' } },
      3500
    );
    const post = payload?.data;
    if (!post) return null;
    return buildAmpPost(post);
  } catch {
    return null;
  }
};

const post = slug
  ? await getOrSetCache(`blog:amp:detail:${slug}`, 45 * 1000, () => fetchPublicPostBySlug(slug))
  : null;

if (!post) {
  Astro.response.status = 404;
}

const canonicalUrl = post ? `/blog/${post.slug}` : '/blog';
const pageTitle = post ? `${post.title} - AMP` : 'Bài viết không tồn tại - AMP';
const pageDescription = post?.excerpt || 'Bài viết không tồn tại hoặc đã bị ẩn.';
const contentBlocks = (post?.contentText || '')
  .split(/(?<=[.!?])\s+/)
  .map((line) => line.trim())
  .filter(Boolean);
---

<!doctype html>
<html {...({ amp: '' } as Record<string, string>)} lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={canonicalUrl} />
    <script is:inline async src="https://cdn.ampproject.org/v0.js"></script>
    <script is:inline async custom-element="amp-img" src="https://cdn.ampproject.org/v0/amp-img-0.1.js"></script>
    <style amp-boilerplate>
      body {
        -webkit-animation: -amp-start 8s steps(1, end) 0s 1 normal both;
        -moz-animation: -amp-start 8s steps(1, end) 0s 1 normal both;
        -ms-animation: -amp-start 8s steps(1, end) 0s 1 normal both;
        animation: -amp-start 8s steps(1, end) 0s 1 normal both
      }
      @-webkit-keyframes -amp-start { from { visibility: hidden } to { visibility: visible } }
      @-moz-keyframes -amp-start { from { visibility: hidden } to { visibility: visible } }
      @-ms-keyframes -amp-start { from { visibility: hidden } to { visibility: visible } }
      @-o-keyframes -amp-start { from { visibility: hidden } to { visibility: visible } }
      @keyframes -amp-start { from { visibility: hidden } to { visibility: visible } }
    </style>
    <noscript>
      <style amp-boilerplate>
        body {
          -webkit-animation: none;
          -moz-animation: none;
          -ms-animation: none;
          animation: none
        }
      </style>
    </noscript>
    <style amp-custom>
      body { font-family: Arial, sans-serif; margin: 0; background: #0b0d0f; color: #f8f5ee; line-height: 1.65; }
      .wrap { max-width: 860px; margin: 0 auto; padding: 18px; }
      .back { display: inline-block; color: #f4d08a; text-decoration: none; margin-bottom: 14px; }
      .meta { color: #f4d08a; font-size: 14px; margin-bottom: 10px; }
      h1 { font-size: 34px; line-height: 1.2; margin: 0 0 10px; }
      .excerpt { color: #d5cdbf; margin: 0 0 16px; }
      .content p { margin: 0 0 12px; color: #f8f5ee; }
      .empty { color: #d5cdbf; }
    </style>
  </head>
  <body>
    <main class="wrap">
      <a class="back" href={canonicalUrl}>← Quay lại bài viết chuẩn</a>
      {post ? (
        <>
          <p class="meta">{post.categoryName} • {post.publishedAt}</p>
          <h1>{post.title}</h1>
          <p class="excerpt">{post.excerpt}</p>
          <amp-img src={post.imageUrl} width="1100" height="600" layout="responsive" alt={post.title}></amp-img>
          <section class="content">
            {contentBlocks.length > 0 ? (
              contentBlocks.map((line) => <p>{line}</p>)
            ) : (
              <p class="empty">Nội dung đang được cập nhật.</p>
            )}
          </section>
        </>
      ) : (
        <>
          <h1>Không tìm thấy bài viết</h1>
          <p class="empty">Bài viết có thể đã bị ẩn hoặc đường dẫn không chính xác.</p>
          <a class="back" href="/blog">Về trang Blog</a>
        </>
      )}
    </main>
  </body>
</html>
