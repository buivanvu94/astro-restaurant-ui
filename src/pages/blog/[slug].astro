---
import SiteLayout from '@/layouts/SiteLayout.astro';
import type { Post } from '@/lib/api/posts';
import type { Product, ProductPrice } from '@/lib/api/products';
import seafoodHero from '@/assets/images/seafood-hero.jpg';
import seafoodRoom from '@/assets/images/seafood-room.jpg';
import seafoodAbout from '@/assets/images/seafood-about.jpg';

export const prerender = false;

interface BlogPostDetail {
  id: number;
  slug: string;
  title: string;
  excerpt: string;
  contentHtml: string;
  categoryName: string;
  publishedAt: string;
  imageUrl: string;
  readMinutes: number;
}

interface LatestPostItem {
  id: number;
  slug: string;
  title: string;
  publishedAt: string;
}

interface BestSellerItem {
  id: number;
  name: string;
  priceText: string;
  imageUrl: string;
}

const { slug } = Astro.params;
const apiBaseUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:5000/api/v1';
const uploadsBaseUrl = apiBaseUrl.replace(/\/api\/v\d+\/?$/, '');
const fallbackImages = [seafoodHero.src, seafoodRoom.src, seafoodAbout.src];

const toAbsoluteImageUrl = (path: string | null | undefined): string | null => {
  if (!path) return null;
  if (path.startsWith('http://') || path.startsWith('https://')) return path;
  return `${uploadsBaseUrl}${path.startsWith('/') ? '' : '/'}${path}`;
};

const formatCurrencyVnd = (value: number): string => `${new Intl.NumberFormat('vi-VN').format(value)} VND`;

const pickDefaultPrice = (prices: ProductPrice[] | undefined): number | null => {
  if (!prices || prices.length === 0) return null;
  const activePrices = prices.filter((price) => price.status === 'active');
  const defaultPrice = activePrices.find((price) => price.is_default) || activePrices[0];
  if (!defaultPrice) return null;
  return Number(defaultPrice.sale_price ?? defaultPrice.price);
};

const plainTextFromHtml = (input: string | null | undefined): string => {
  return (input || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
};

const normalizeExcerpt = (excerpt: string | null | undefined, content: string | null | undefined): string => {
  const source = excerpt?.trim() || plainTextFromHtml(content);
  if (!source) return 'Khám phá góc nhìn ẩm thực và trải nghiệm fine dining tại Aurelian Seafood.';
  return source.length > 190 ? `${source.slice(0, 190).trim()}...` : source;
};

const formatDateVi = (input: string | null | undefined): string => {
  if (!input) return 'Mới cập nhật';
  const parsed = new Date(input);
  if (Number.isNaN(parsed.getTime())) return 'Mới cập nhật';
  return parsed.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
};

const estimateReadTime = (content: string | null | undefined): number => {
  const text = plainTextFromHtml(content);
  if (!text) return 1;
  const words = text.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(words / 220));
};

const fetchPublicPostBySlug = async (postSlug: string): Promise<BlogPostDetail | null> => {
  try {
    const response = await fetch(`${apiBaseUrl}/posts/public/slug/${encodeURIComponent(postSlug)}`, {
      headers: { accept: 'application/json' }
    });
    if (!response.ok) return null;

    const payload = await response.json();
    const post: Post | null = payload?.data || null;
    if (!post) return null;

    return {
      id: post.id,
      slug: post.slug,
      title: post.title,
      excerpt: normalizeExcerpt(post.excerpt, post.content),
      contentHtml: post.content || '',
      categoryName: post.category?.name || 'Ẩm thực',
      publishedAt: formatDateVi(post.published_at || post.created_at),
      imageUrl:
        toAbsoluteImageUrl(post.featuredImage?.thumbnail_path)
        || toAbsoluteImageUrl(post.featuredImage?.path)
        || fallbackImages[0],
      readMinutes: estimateReadTime(post.content)
    };
  } catch {
    return null;
  }
};

const fetchLatestPosts = async (excludeSlug: string): Promise<LatestPostItem[]> => {
  try {
    const response = await fetch(`${apiBaseUrl}/posts/public?page=1&limit=8`, {
      headers: { accept: 'application/json' }
    });
    if (!response.ok) return [];

    const payload = await response.json();
    const posts: Post[] = Array.isArray(payload?.data) ? payload.data : [];

    return posts
      .filter((item) => item.slug !== excludeSlug)
      .slice(0, 6)
      .map((item) => ({
        id: item.id,
        slug: item.slug,
        title: item.title,
        publishedAt: formatDateVi(item.published_at || item.created_at)
      }));
  } catch {
    return [];
  }
};

const fetchBestSellerProducts = async (): Promise<BestSellerItem[]> => {
  const mapProducts = (products: Product[]): BestSellerItem[] => {
    return products.slice(0, 6).map((product, index) => {
      const priceValue = pickDefaultPrice(product.prices);
      return {
        id: product.id,
        name: product.name,
        priceText: priceValue !== null ? formatCurrencyVnd(priceValue) : 'Liên hệ',
        imageUrl:
          toAbsoluteImageUrl(product.featuredImage?.thumbnail_path)
          || toAbsoluteImageUrl(product.featuredImage?.path)
          || fallbackImages[index % fallbackImages.length]
      };
    });
  };

  try {
    const featuredResponse = await fetch(`${apiBaseUrl}/products/public?page=1&limit=6&isFeatured=true`, {
      headers: { accept: 'application/json' }
    });
    if (featuredResponse.ok) {
      const featuredPayload = await featuredResponse.json();
      const featuredProducts: Product[] = Array.isArray(featuredPayload?.data) ? featuredPayload.data : [];
      if (featuredProducts.length > 0) return mapProducts(featuredProducts);
    }

    const fallbackResponse = await fetch(`${apiBaseUrl}/products/public?page=1&limit=6`, {
      headers: { accept: 'application/json' }
    });
    if (!fallbackResponse.ok) return [];

    const fallbackPayload = await fallbackResponse.json();
    const fallbackProducts: Product[] = Array.isArray(fallbackPayload?.data) ? fallbackPayload.data : [];
    return mapProducts(fallbackProducts);
  } catch {
    return [];
  }
};

const post = slug ? await fetchPublicPostBySlug(slug) : null;

if (!post) {
  Astro.response.status = 404;
}

const [latestPosts, bestSellers] = post
  ? await Promise.all([fetchLatestPosts(post.slug), fetchBestSellerProducts()])
  : [[], []];

const pageTitle = post ? `${post.title} - Blog Aurelian Seafood` : 'Bài viết không tồn tại - Aurelian Seafood';
const pageDescription = post?.excerpt || 'Bài viết không tồn tại hoặc đã bị ẩn.';
---

<SiteLayout title={pageTitle} description={pageDescription}>
  <section class="relative overflow-hidden">
    <div class="absolute -top-24 -left-24 w-72 h-72 bg-amber-500/20 rounded-full blur-3xl"></div>
    <div class="absolute top-8 right-0 w-72 h-72 bg-teal-400/20 rounded-full blur-3xl"></div>
    <div class="max-w-6xl mx-auto px-6 pt-16 pb-10">
      <a href="/blog" class="blog-back-link">Quay lại Blog</a>
    </div>
  </section>

  <section class="section-shell pt-0">
    <div class="max-w-6xl mx-auto px-6">
      {post ? (
        <div class="blog-layout">
          <article class="card-glass blog-detail-card">
            <div class="blog-detail-media-wrap">
              <img
                src={post.imageUrl}
                alt={post.title}
                class="blog-detail-media"
                loading="eager"
                decoding="async"
                width="1100"
                height="600"
              />
            </div>
            <div class="p-6 md:p-10">
              <div class="flex flex-wrap items-center gap-3 text-sm text-amber-200/80 mb-4">
                <span class="badge">{post.categoryName}</span>
                <span>{post.publishedAt}</span>
                <span>{post.readMinutes} phút đọc</span>
              </div>
              <h1 class="blog-detail-title">{post.title}</h1>
              <p class="blog-detail-excerpt">{post.excerpt}</p>
              <div class="blog-content prose-content" set:html={post.contentHtml}></div>
            </div>
          </article>

          <aside class="blog-sidebar">
            <section class="card-glass p-5 md:p-6">
              <h3 class="blog-sidebar-title">Món ăn best seller</h3>
              {bestSellers.length > 0 ? (
                <div class="blog-side-list">
                  {bestSellers.map((item) => (
                    <a href="/menu" class="blog-side-item">
                      <img
                        src={item.imageUrl}
                        alt={item.name}
                        class="blog-side-thumb"
                        loading="lazy"
                        decoding="async"
                        width="120"
                        height="86"
                      />
                      <div>
                        <p class="blog-side-name">{item.name}</p>
                        <p class="blog-side-price">{item.priceText}</p>
                      </div>
                    </a>
                  ))}
                </div>
              ) : (
                <p class="text-slate-300">Chưa có dữ liệu món ăn best seller.</p>
              )}
            </section>

            <section class="card-glass p-5 md:p-6">
              <h3 class="blog-sidebar-title">Bài viết mới nhất</h3>
              {latestPosts.length > 0 ? (
                <div class="blog-side-list">
                  {latestPosts.map((item) => (
                    <a href={`/blog/${item.slug}`} class="blog-latest-item">
                      <p class="blog-latest-title">{item.title}</p>
                      <p class="blog-latest-date">{item.publishedAt}</p>
                    </a>
                  ))}
                </div>
              ) : (
                <p class="text-slate-300">Chưa có bài viết mới.</p>
              )}
            </section>
          </aside>
        </div>
      ) : (
        <div class="card-glass p-10 text-center">
          <h1 class="text-3xl mb-3">Không tìm thấy bài viết</h1>
          <p class="text-slate-300 mb-5">Bài viết có thể đã bị ẩn hoặc đường dẫn không chính xác.</p>
          <a href="/blog" class="btn-primary inline-block">Về trang Blog</a>
        </div>
      )}
    </div>
  </section>
</SiteLayout>
